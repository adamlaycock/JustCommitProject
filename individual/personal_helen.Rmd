---
title: "Helen Personal Investigation"
author: ""
date: "`r Sys.Date()`"
output: html_document
---

**Note:** You can use this file as you 'working document' where you can try out various investigation ideas and keep notes about your findings. How you use and structure this file is up to you. It is recommended that you keep notes about what you are investigating and what you find as this will make the process of creating your presentation and report easier. Please note that you _do not_ need to submit this file as part of your group project.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-lib, message = FALSE}
library(tidyverse)
library(tidymodels)
library(janitor)
```

```{r load-data}
details = read_rds('../data/clean_data/details_clean.rds')
fatalities = read_rds('../data/clean_data/fatalities_clean.rds')
```

```{r}
#remove irrelevant variables for ENSO analysis
details_smaller <- details %>% 
  select(-region_fips,
         -cz_type, 
         -cz_fips, 
         cz_timezone, 
         -wfo, 
         -source, 
         -tor_other_cz_state, 
         -tor_other_cz_fips, 
        )

#add a column for ENSO status
details_enso <- details_smaller %>% 
  mutate(enso_status = case_when(
         year(begin_dt) %in% c(1998, 
                               2003, 
                               2007, 
                               2010, 
                               2016,
                               2023
                               ) ~ 'el_nino',
         year(begin_dt) %in% c(1999, 
                               2000, 
                               2008, 
                               2011, 
                               2012, 
                               2021, 
                               2022
                               ) ~ 'la_nina',
         TRUE ~ 'neutral'
  ))
```

```{r}
#calculate proportion of total events by event type for el nino years
el_nino_freq <- details_enso %>% 
  filter(enso_status == 'el_nino') %>%
  count(event_type) %>% 
  mutate(proportion_en = n / sum(n))

#calculate proportion of total events by event type for la nina years
la_nina_freq <- details_enso %>% 
  filter(enso_status == 'la_nina') %>%
  count(event_type) %>% 
  mutate(proportion_ln = n / sum(n))

#calculate proportion of total events by event type in neutral years
neutral_freq <- details_enso %>% 
  filter(enso_status == 'neutral') %>%
  count(event_type) %>% 
  mutate(proportion_n = n / sum(n))

#join previous frequency dataframes into one
proportions_enso <- full_join(el_nino_freq, neutral_freq, by = 'event_type') %>% 
  full_join(la_nina_freq, by='event_type') %>% 
  top_n((abs(proportion_en-proportion_ln)), n = 10) %>% 
  pivot_longer(cols = c(proportion_en, proportion_ln, proportion_n), 
               names_to = 'enso_status', 
               values_to = 'proportion'
               )
#reorder ENSO status for plotting
proportions_enso <- proportions_enso %>%
  mutate(enso_status = factor(enso_status, levels = c("proportion_en", "proportion_n", "proportion_ln")))

#plot joined dataframe
proportions_enso %>% 
  ggplot(aes(fill=enso_status, 
             x = proportion, 
             y = reorder(event_type, proportion))
         ) +
  geom_col(position = 'dodge') +
  labs(
    x="Proportion of Total Events in Common ENSO Status Years",
    y="Event Type",
    title="Proportion of Total Events by Event Type and ENSO Status",
    subtitle="Event types with largest difference between El Ni単o and La Ni単a years",
    fill = 'ENSO Status'
  ) +
  scale_fill_manual(
    values = c('proportion_en' = 'midnightblue', 'proportion_n' = 'purple2', 'proportion_ln' = 'mediumorchid2' ),
    labels = c('El Ni単o', 'Neutral', 'La Ni単a')
  )
```

```{r, eval=FALSE}
#tears of sadness
enso_knn <- details_enso %>% 
  select(event_id, 
         region, 
         event_type, 
         injuries_direct, 
         injuries_indirect, 
         deaths_direct, 
         deaths_indirect, 
         damage_property, 
         damage_crops, 
         damage_total, 
         enso_status
         )
#train/test split
set.seed(70405)
enso_knn_split <- initial_split(enso_knn)
enso_knn_train <- training(enso_knn_split)
enso_knn_test  <- testing(enso_knn_split)

enso_knn_recipe <- recipe(enso_status ~ ., 
                      data = enso_knn
                      ) %>% 
  step_naomit(all_predictors()) %>% #ensure no predictors are missing
  step_dummy(all_nominal(), -all_outcomes()) #create dummy variables
```


```{r}
#create frequency table of ENSO events
details_enso %>% 
  group_by(enso_status) %>% 
  summarise(count = n(),
            prop = n()/nrow(details_enso),
            exp_prop = length(unique(year(begin_dt)))
            /length(unique(year(details_enso$begin_dt)))
  )
```

Source = <https://psl.noaa.gov/enso/past_events.html> added 2023 as an el nino year, find source for that as well. Note the caveat with events vs episodes


