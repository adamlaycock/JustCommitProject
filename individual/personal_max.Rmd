---
title: "Max Personal Investigation"
author: ""
date: "`r Sys.Date()`"
output: html_document
---

**Note:** You can use this file as you 'working document' where you can try out various investigation ideas and keep notes about your findings. How you use and structure this file is up to you. It is recommended that you keep notes about what you are investigating and what you find as this will make the process of creating your presentation and report easier. Please note that you _do not_ need to submit this file as part of your group project.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-lib, message = FALSE}
library(tidyverse)
library(janitor)
library(broom)
library(patchwork)
```

```{r load-data}
details = read_rds('../data/clean_data/details_clean.rds')
fatalities = read_rds('../data/clean_data/fatalities_clean.rds')
```

```{r Details testing}
# Rename redundant event type names
  details <- details %>%
    mutate(event_type = replace(event_type, event_type == "Hurricane (Typhoon)", "Hurricane"))

# Select relevant columns and replace NA values
details_selected <- details %>%
  select(event_type, deaths_direct, deaths_indirect, damage_total, begin_dt) %>%  
  mutate(
    year = as.numeric(format(as.Date(begin_dt, format = "%Y-%m-%d"), "%Y"))  
  ) %>%
  na.omit()
glimpse(details_selected)

# Calculate total fatalities and damage per event, and group by event type
details_grouped <- details_selected %>%
  mutate(
    fatalities_total = deaths_direct + deaths_indirect  # Calculate total fatalities
  ) %>%
  group_by(event_type) %>%
  summarise(
    avg_fatalities_by_type = mean(fatalities_total, na.rm = TRUE),  
    avg_damage_by_type = mean(damage_total, na.rm = TRUE)  
  ) %>%
  ungroup()

# Calculate global averages and assign groups
global_averages <- details_grouped %>%
  summarise(
    global_avg_fatalities = mean(avg_fatalities_by_type, na.rm = TRUE),  
    global_avg_damage = mean(avg_damage_by_type, na.rm = TRUE)  
  )

# Add grouping for more/less deadly and damaging based on global averages
details_grouped <- details_grouped %>%
  mutate(
    fatality_group = if_else(avg_fatalities_by_type > global_averages$global_avg_fatalities,
                             "More Deadly", "Less Deadly"),
    damage_group = if_else(avg_damage_by_type > global_averages$global_avg_damage,
                           "More Damaging", "Less Damaging")
  )

## Create side-by-side plots using bar plots

# Adjusted Graph for Fatalities (All Data)
fatality_graph <- details_grouped %>%
  ggplot(aes(x = fatality_group, 
             y = avg_fatalities_by_type, 
             fill = fatality_group)) +
  stat_summary(fun = "mean", geom = "bar", position = "dodge", alpha = 0.7) +
  scale_fill_manual(values = c("More Deadly" = "red", "Less Deadly" = "green")) +
  labs(
    title = "Average Fatalities by Group",
    subtitle = "Based on Event Type Averages Compared to Global Average",
    x = "Weather Group",  # Renamed the x-axis
    y = "Average Fatalities per Event Type",
    fill = NULL
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.subtitle = element_text(size = 6.5),  # Adjust subtitle font size
    axis.text.x = element_text(size = 5)  # Adjust x-axis text size to avoid overlap
  )

# Adjusted Graph for Damages (All Data)
damage_graph <- details_grouped %>%
  ggplot(aes(x = damage_group, 
             y = avg_damage_by_type, 
             fill = damage_group)) +
  stat_summary(fun = "mean", geom = "bar", position = "dodge", alpha = 0.7) +
  scale_fill_manual(values = c("More Damaging" = "purple", "Less Damaging" = "orange")) +
  labs(
    title = "Average Damages by Group",
    subtitle = "Based on Event Type Averages Compared to Global Average",
    x = "Weather Group",  # Renamed the x-axis
    y = "Average Damages per Event Type (USD)",
    fill = NULL
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.subtitle = element_text(size = 6.5),  # Adjust subtitle font size
    axis.text.x = element_text(size = 5)  # Adjust x-axis text size to avoid overlap
  )

# Filter for 1996
details_1996_7 <- details_selected %>% filter(year %in% c(1996, 1997))
details_grouped_1996_7 <- details_1996_7 %>%
  mutate(fatalities_total = deaths_direct + deaths_indirect) %>%
  group_by(event_type) %>%
  summarise(
    avg_fatalities_by_type = mean(fatalities_total, na.rm = TRUE),
    avg_damage_by_type = mean(damage_total, na.rm = TRUE)
  ) %>%
  ungroup()

# Recalculate global averages for 1996 data
global_averages_1996_7 <- details_grouped_1996_7 %>%
  summarise(
    global_avg_fatalities = mean(avg_fatalities_by_type, na.rm = TRUE),
    global_avg_damage = mean(avg_damage_by_type, na.rm = TRUE)
  )

# Add grouping for 1996 data
details_grouped_1996_7 <- details_grouped_1996_7 %>%
  mutate(
    fatality_group = if_else(avg_fatalities_by_type > global_averages_1996_7$global_avg_fatalities,
                             "More Deadly", "Less Deadly"),
    damage_group = if_else(avg_damage_by_type > global_averages_1996_7$global_avg_damage,
                           "More Damaging", "Less Damaging")
  )

# Adjusted Graph for 1996 Fatalities
fatality_graph_1996_7 <- details_grouped_1996_7 %>%
  ggplot(aes(x = fatality_group, 
             y = avg_fatalities_by_type, 
             fill = fatality_group)) +
  stat_summary(fun = "mean", geom = "bar", position = "dodge", alpha = 0.7) +
  labs(title = "1996-7: Fatalities by Group", subtitle = "Data from 1996-7", 
       x = "Weather Group",  # Renamed the x-axis
       y = "Average Fatalities") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 5)  # Adjust x-axis text size to avoid overlap
  )

# Adjusted Graph for 1996 Damages
damage_graph_1996_7 <- details_grouped_1996_7 %>%
  ggplot(aes(x = damage_group, 
             y = avg_damage_by_type, 
             fill = damage_group)) +
  stat_summary(fun = "mean", geom = "bar", position = "dodge", alpha = 0.7) +
  labs(title = "1996-7: Damages by Group", subtitle = "Data from 1996-7", 
       x = "Weather Group",  # Renamed the x-axis
       y = "Average Damages (USD)") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 5)  # Adjust x-axis text size to avoid overlap
  )

# Filter for 2022-3
details_2022_3 <- details_selected %>% filter(year %in% c(2022, 2023))
details_grouped_2022_3 <- details_2022_3 %>%
  mutate(fatalities_total = deaths_direct + deaths_indirect) %>%
  group_by(event_type) %>%
  summarise(
    avg_fatalities_by_type = mean(fatalities_total, na.rm = TRUE),
    avg_damage_by_type = mean(damage_total, na.rm = TRUE)
  ) %>%
  ungroup()

# Recalculate global averages for 2022-3 data
global_averages_2022_3 <- details_grouped_2022_3 %>%
  summarise(
    global_avg_fatalities = mean(avg_fatalities_by_type, na.rm = TRUE),
    global_avg_damage = mean(avg_damage_by_type, na.rm = TRUE)
  )

# Add grouping for 2022-3 data
details_grouped_2022_3 <- details_grouped_2022_3 %>%
  mutate(
    fatality_group = if_else(avg_fatalities_by_type > global_averages_2022_3$global_avg_fatalities,
                             "More Deadly", "Less Deadly"),
    damage_group = if_else(avg_damage_by_type > global_averages_2022_3$global_avg_damage,
                           "More Damaging", "Less Damaging")
  )

# Adjusted Graph for 2022-3 Fatalities
fatality_graph_2022_3 <- details_grouped_2022_3 %>%
  ggplot(aes(x = fatality_group, 
             y = avg_fatalities_by_type, 
             fill = fatality_group)) +
  stat_summary(fun = "mean", geom = "bar", position = "dodge", alpha = 0.7) +
  labs(title = "2022-3: Fatalities by Group", subtitle = "Data from 2022-3", 
       x = "Weather Group",  # Renamed the x-axis
       y = "Average Fatalities") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 5)  # Adjust x-axis text size to avoid overlap
  )

# Adjusted Graph for 2022-3 Damages
damage_graph_2022_3 <- details_grouped_2022_3 %>%
  ggplot(aes(x = damage_group, 
             y = avg_damage_by_type, 
             fill = damage_group)) +
  stat_summary(fun = "mean", geom = "bar", position = "dodge", alpha = 0.7) +
  labs(title = "2022-3: Damages by Group", subtitle = "Data from 2022-3", 
       x = "Weather Group",  # Renamed the x-axis
       y = "Average Damages (USD)") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 5)  # Adjust x-axis text size to avoid overlap
  )

# Combine all plots
combined_original <- fatality_graph + damage_graph
combined_1996_7 <- fatality_graph_1996_7 + damage_graph_1996_7
combined_2022_3 <- fatality_graph_2022_3 + damage_graph_2022_3

# Display plots
combined_original
combined_1996_7
combined_2022_3

# Display values

# Exact values for the original chart
details_grouped %>%
  select(event_type, fatality_group, damage_group, avg_fatalities_by_type, avg_damage_by_type) %>%
  arrange(fatality_group, damage_group)

# Exact values for 1996-7
details_grouped_1996_7 %>%
  select(event_type, fatality_group, damage_group, avg_fatalities_by_type, avg_damage_by_type) %>%
  arrange(fatality_group, damage_group) 

# Exact values for 2022-3
details_grouped_2022_3 %>%
  select(event_type, fatality_group, damage_group, avg_fatalities_by_type, avg_damage_by_type) %>%
  arrange(fatality_group, damage_group)

```
